<!doctype html><html lang=ko dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 | 봄을 기다리는 낙엽</title>
<meta name=keywords content="springboot,implement,mysql,datasource,jpa"><meta name=description content="이중화된 MySQL DB에 접근할 수 있는 DataSource를 설정합니다."><meta name=author content="Leaf"><link rel=canonical href=http://localhost:1313/posts/cqrs/3/><meta name=google-site-verification content="l76eAEMadEn1QzS8fLTbrl8ppayZprvV3uuAbMGSy_c"><meta name=msvalidate.01 content="XYZabc"><meta name=naver-site-verification content="adff811404d441495a954e30579f40297ba14f5e"><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ko href=http://localhost:1313/posts/cqrs/3/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-9PNFP00SSG"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9PNFP00SSG")}</script><meta property="og:url" content="http://localhost:1313/posts/cqrs/3/"><meta property="og:site_name" content="봄을 기다리는 낙엽"><meta property="og:title" content="[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현"><meta property="og:description" content="이중화된 MySQL DB에 접근할 수 있는 DataSource를 설정합니다."><meta property="og:locale" content="ko"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-19T20:20:06+09:00"><meta property="article:modified_time" content="2024-03-19T20:20:06+09:00"><meta property="article:tag" content="Springboot"><meta property="article:tag" content="Implement"><meta property="article:tag" content="Mysql"><meta property="article:tag" content="Datasource"><meta property="article:tag" content="JPA"><meta property="og:image" content="http://localhost:1313/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/cover.png"><meta name=twitter:title content="[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현"><meta name=twitter:description content="이중화된 MySQL DB에 접근할 수 있는 DataSource를 설정합니다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"[MySQL, Java]Spring CQRS 패턴 구현을 위한 DB 이중화","item":"http://localhost:1313/posts/cqrs/"},{"@type":"ListItem","position":3,"name":"[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현","item":"http://localhost:1313/posts/cqrs/3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현","name":"[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현","description":"이중화된 MySQL DB에 접근할 수 있는 DataSource를 설정합니다.","keywords":["springboot","implement","mysql","datasource","jpa"],"articleBody":"도입 이전 포스팅 참조 : DB 이중화 및 CQRS 패턴의 중요성 \u003e MySQL Replication Database 구현\n실습환경\nDocker : v25.0.3 MySQL : v8.3.0 Java : v17.0.9 Spring : v3.2.4 저번 시간에 생성한 Master / Slave DB에 SpringBoot를 직접 연동해서 CRUD를 하는 실습을 진행합니다.\n프로젝트 생성 Springboot 프로젝트를 생성합니다. 아래 사진과 같이 JPA, Lombok, MySQL Driver 의존성을 추가하겠습니다. 스프링부트 프로젝트를 위와 같이 의존성을 추가하여 생성합니다.\nbuild.gradle 실행 위에서 생성한 프로젝트의 jar파일을 풀고, build.gradle 파일을 intellij 혹은 eclipse로 실행합니다. gradle로 프로젝트를 실행하면 자동으로 소스파일 경로가 생성됩니다.\nJpaConfig 클래스 생성 원래 스프링부트에 JPA 의존성을 추가하면 기본으로 설정된 DataSource를 불러와 사용하지만, 저번 시간에 분리한 Command(쓰기)와 Query(읽기) DB를 DataSource로 사용하기 위해 다음과 같이 JpaConfig를 설정하겠습니다.\npackage com.replication.demo.config; // config 패키지 생성 import org.springframework.context.annotation.Configuration; @Configuration // Spring에 자동으로 Bean을 등록하기 위함 public class JpaConfig {} DataSource 구현 JpaConfig내부에 DataSource를 Bean으로 등록하면, 이후 Spring이 해당 Bean의 설정을 통해 DataSource를 생성하므로 편리하게 DB에 접근할 수 있습니다.\n두 개의 DataSource를 각각 구현하고, Transaction시점에 필요한 DataSource를 결정할 수 있도록 Spring에서는 AbstractRoutingDataSource라는 추상클래스를 제공합니다.\nCommand \u0026 Read DataSource Bean 생성 우선, 쓰기와 읽기 DataSource를 다음과 같이 JpaConfig 내부에서 Bean으로 등록합니다.\n@Configuration public class JpaConfig { @Bean(\"commandDataSource\") // 원본 DB와 연결된 DataSource public DataSource commandDataSource() { HikariDataSource dataSource = DataSourceBuilder.create() .driverClassName(\"com.mysql.cj.jdbc.Driver\") .url(\"jdbc:mysql://localhost:3307/target_db\") .username(\"master_user\") .password(\"1234\") .type(HikariDataSource.class) .build(); dataSource.setMaximumPoolSize(2); // Pool Size도 설정 가능합니다. return dataSource; } @Bean(\"queryDataSource\") // Repl DB와 연결된 DataSource public DataSource queryDataSource() { HikariDataSource dataSource = DataSourceBuilder.create() .driverClassName(\"com.mysql.cj.jdbc.Driver\") .url(\"jdbc:mysql://localhost:3308/target_db\") .username(\"slave_user\") .password(\"1234\") .type(HikariDataSource.class) .build(); dataSource.setMaximumPoolSize(5); // 보통 읽기전용 작업이 더 많기 때문에 크게 설정하겠습니다. } } jdbc에서 사용하는 port 및 username과 password는 저번 시간에 생성한 DB 환경변수를 참고하시면 됩니다.\nRoutingDataSource 구현 읽기전용 트랜잭션인지 여부에 따라 동적으로 DataSource를 사용해야 하므로, 스프링에게 트랜잭션 시점에 해당 작업에 대해 알려주고, 필요한 DataSource를 동적으로 불러오도록 해야 합니다.\n이를 위해 다음과 같이 추상 클래스인 AbstractRoutingDataSource를 상속받는 사용자 정의 클래스를 생성합니다.\n@Slf4j // AbstractRoutingDataSource 구현 public static class ReplicationRoutingDataSource extends AbstractRoutingDataSource { @Override protected Object determineCurrentLookupKey() { boolean isReadOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly(); log.info(\"Use ReadOnly Datasource : {}\", isReadOnly); return isReadOnly ? \"replication\" : \"original\"; } } 위 설정에서 determineCurrentLookupKey 메서드를 구현하면 동적으로 DataSource를 라우팅하는 것이 가능한데, 그 key를 TransactionSynchronizationManager1의 속성값(isCurrentTransactionReadOnly; 현재 트랜잭션이 읽기전용인지?)으로 사용해서 DataSource를 읽기 / 쓰기 시점에 결정합니다.\n다음으로 위 클래스를 활용해서 실제로 DataSource를 결정 후 해당 DataSource를 Bean으로 등록합니다.\nReplicationRoutingDataSource 클래스는 AbstractRoutingDataSource를 상속받고 있기 때문에 해당 추상클래스의 메서드를 사용가능하여 다음과 같이 ReadOnly 여부에 따른 데이터소스를 설정하는 것이 가능합니다.\nReadOnly여부는 @Transactional(readOnly = true)인지를 확인하여 결정됩니다. 이 때, org.springframework.transaction.annotation.Transactional을 사용해야 함을 주의합니다. (jakarta.transactional 아님!!)\n@Bean(\"routingDataSource\") // DataSource 종류에 따른 DataSource 라우팅(변경) public DataSource routingDataSource(@Qualifier(\"commandDataSource\") DataSource commandDataSource, @Qualifier(\"queryDataSource\") DataSource queryDataSource) { ReplicationRoutingDataSource routingDataSource = new ReplicationRoutingDataSource(); // DataSource 라우팅 Map\u003cObject, Object\u003e dataSourceMap = new HashMap\u003c\u003e(); dataSourceMap.put(\"command\", commandDataSource); dataSourceMap.put(\"query\", queryDataSource); // 기본 DataSource 및 ReadOnly 여부에 따른 DataSource 설정 routingDataSource.setDefaultTargetDataSource(commandDataSource); // commandDataSource를 기본 사용 routingDataSource.setTargetDataSources(dataSourceMap); // ReadOnly여부에 따른 DataSource 변경 return routingDataSource; } 다음으로 위의 Bean을 LazyConnectionDataSourceProxy으로 감싸는데, 이는 트랜잭션 진입 시점이 아닌 실제 커넥션이 필요한 시점2에 DataSource를 결정하기 위함입니다.\n@Bean(\"routingLazyDataSource\") // Connection 시점에 DataSource 결정하기 위한 Proxy public DataSource routingLazyDataSource(@Qualifier(\"routingDataSource\") DataSource routingDataSource) { return new LazyConnectionDataSourceProxy(routingDataSource); } EntityManagerFactory 구현 Spring에서는 트랜잭션의 동시성 문제3를 해결하기 위해 EntityManager를 트랜잭션 시마다 생성하는 Factory Method 패턴을 구현하고 있습니다. 이를 위해 저희도 EntityManagerFactory에 위에서 설정한 DataSource를 직접 주입함으로써 동시성 문제를 해결할 수 있습니다.\n@Bean(\"entityManagerFactory\") // Entity 를 관리하기 위한 JPA Manager 설정 LocalContainerEntityManagerFactoryBean entityManagerFactory( @Qualifier(\"routingLazyDataSource\") DataSource dataSource) { LocalContainerEntityManagerFactoryBean emf = new LocalContainerEntityManagerFactoryBean(); // DataSource 설정 emf.setDataSource(dataSource); // EntityManager 가 관리할 Base Package 설정 emf.setPackagesToScan(\"com.replication.demo.*\"); // Hibernate Vendor Adaptor 설정 HibernateJpaVendorAdapter hibernateJpaVendorAdapter = new HibernateJpaVendorAdapter(); hibernateJpaVendorAdapter.setDatabasePlatform(\"org.hibernate.dialect.MySQLDialect\"); emf.setJpaVendorAdapter(hibernateJpaVendorAdapter); // JPA 및 Hibernate 설정 Properties properties = new Properties(); properties.setProperty(\"spring.jpa.hibernate.ddl-auto\", \"create-drop\"); properties.setProperty(\"hibernate.show_sql\",\"true\"); properties.setProperty(\"hibernate.format_sql\",\"true\"); properties.setProperty(\"hibernate.default_batch_fetch_size\", \"100\"); emf.setJpaProperties(properties); return emf; } Vendor Adaptor는 JPA 구현체를 선택하기 위함이며, 보통 Hibernate를 많이 사용합니다.4 기타 JPA 및 Hibernate 설정은 JPA 공식 문서와 Hibernate 공식 문서에서 더욱 자세한 옵션과 설명을 확인하실 수 있습니다.\nTransactionManager 구현 Spring에서 @Transactional를 통해 트랜잭션이 발생하면, Spring Container에서 TransactinManager를 불러와 트랜잭션을 수행합니다. 이 때, 위에서 구현한 DataSource와 EntityManager를 사용해서 트랜잭션을 수행하도록 하겠습니다.\n@Bean(\"transactionManager\") // 트랜잭션 매니저 설정 public PlatformTransactionManager transactionManager( @Qualifier(\"entityManagerFactory\") EntityManagerFactory entityManagerFactory) { JpaTransactionManager jpaTransactionManager = new JpaTransactionManager(); jpaTransactionManager.setEntityManagerFactory(entityManagerFactory); return jpaTransactionManager; } PlatformTransactionManager는 다양한 플랫폼의 트랜잭션을 지원하기 위한 클래스이며, 위에서는 JpaTransactionManager를 사용했지만 HibernateTransactionManager나 JdbcTransactionManager등의 플랫폼도 사용 가능합니다.\n테스트 이제 Config 설정이 완료되었으니, 직접 Test를 통해 원하는 기능이 제대로 실행되는지 확인해보겠습니다.\nEntity 생성 테스트코드를 작성하기 전, DB에 저장할 엔티티 클래스를 먼저 생성하겠습니다.\nUser Entity 생성\npackage com.replication.demo.entity; import jakarta.persistence.*; import lombok.*; import java.util.List; @Entity(name = \"users\") @NoArgsConstructor @Getter @Setter public class User { @Id @GeneratedValue @Column(name = \"user_id\") private Long id; private String name; private Integer age; @OneToMany(mappedBy = \"owner\") private List\u003cComputer\u003e computers; } Computer Entity 생성\npackage com.replication.demo.entity; import jakarta.persistence.*; import lombok.Getter; import lombok.NoArgsConstructor; import lombok.Setter; @Entity(name = \"computer\") @NoArgsConstructor @Getter @Setter public class Computer { @Id @GeneratedValue @Column(name = \"computer_id\") private Long id; @Enumerated(EnumType.STRING) private ComputerType type; @Column(name = \"os\") private String OS; @ManyToOne @JoinColumn(name = \"owner_id\") private User owner; } Computer Type 생성\npackage com.replication.demo.entity; public enum ComputerType { MAC, WINDOW, LINUX } 테스트코드 작성 마지막으로, 테스트코드를 통해 Command(readOnly = false) 트랜잭션과 Query(readOnly = true) 트랜잭션을 분리하여 정상적으로 조회되는지 확인해보겠습니다.\npackage com.replication.demo; import com.replication.demo.entity.Computer; import com.replication.demo.entity.ComputerType; import com.replication.demo.entity.User; import jakarta.persistence.EntityManager; import jakarta.persistence.PersistenceContext; import org.junit.jupiter.api.*; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.annotation.Rollback; import org.springframework.transaction.annotation.Transactional; import java.util.ArrayList; import java.util.List; import static org.assertj.core.api.Assertions.assertThat; @SpringBootTest @TestMethodOrder(MethodOrderer.OrderAnnotation.class) class DemoApplicationTests { @PersistenceContext EntityManager em; @Test @Order(1) void contextLoads() { } @Test @Order(2) @DisplayName(\"최초 데이터 입력\") @Transactional(readOnly = false) @Rollback(value = false) void init() { // 사용자 생성 User user = new User(); user.setAge(28); user.setName(\"leaf\"); // 컴퓨터 1 생성 및 저장 List\u003cComputer\u003e computers = new ArrayList\u003c\u003e(); Computer macCom = new Computer(); macCom.setOS(\"Ventura\"); macCom.setType(ComputerType.MAC); macCom.setOwner(user); computers.add(macCom); em.persist(macCom); // 컴퓨터 2 생성 및 저장 Computer windowCom = new Computer(); windowCom.setOS(\"WINDOW 11\"); windowCom.setType(ComputerType.WINDOW); windowCom.setOwner(user); computers.add(windowCom); em.persist(windowCom); // 컴퓨터 사용자에 추가 후 사용자 저장 user.setComputers(computers); em.persist(user); em.flush(); em.clear(); } @Test @Order(3) @DisplayName(\"사용자 조회 시 컴퓨터 잘 불러오는지 테스트\") @Transactional(readOnly = true) void userQueryWithComputer() { // given List\u003cUser\u003e users = em.createQuery( \"select u \" + \"from users as u \" + \"join u.computers as c\", User.class) .getResultList(); // when User userInDB = users.get(0); // then // 사용자명, 나이 테스트 assertThat(userInDB.getName()).isEqualTo(\"leaf\"); assertThat(userInDB.getAge()).isEqualTo(28); assertThat(userInDB.getComputers()).hasSize(2); // 맥북 컴퓨터 가지고 있는지 테스트 assertThat(userInDB.getComputers()).anyMatch(c -\u003e c.getOS().equals(\"Ventura\")); assertThat(userInDB.getComputers()).anyMatch(c -\u003e c.getType().equals(ComputerType.MAC)); // 윈도우 컴퓨터 가지고 있는지 테스트 assertThat(userInDB.getComputers()).anyMatch(c -\u003e c.getOS().equals(\"WINDOW 11\")); assertThat(userInDB.getComputers()).anyMatch(c -\u003e c.getType().equals(ComputerType.WINDOW)); } } @RollBack(false)를 통해 롤백을 방지한 후 다음 테스트가 실행되도록 설계했습니다.5\n테스트 실행결과, 위와 같이 데이터소스 선택 및 실제 SQL이 잘 나가는 것을 확인할 수 있습니다.\n결론 지금까지 이중화된 DB의 데이터소스를 SpringBoot에서 동적으로 선택하여 실제 DB와 연동 후 테스트까지 수행했습니다. 해당 프로젝트의 소스코드는 깃허브에 올려두었으니, 필요 시 참고하시기 바랍니다.\nReferences URL 게시일자 방문일자 작성자 https://docs.spring.io/spring-data/relational/reference/jdbc/getting-started.html 미확인 2024.03.31. Spring https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.data 미확인 2024.04.10. Spring https://stackoverflow.com/questions/24643863/is-entitymanager-really-thread-safe 2014.07.09. 2024.04.10. Ken Y-N 트랜잭션 동기화 기법을 사용하기 위한 클래스입니다. 보통 여러 트랜잭션을 한번에 커밋 및 롤백하여 정합성을 보장하기 위해 사용합니다. ↩︎\n특히 Hibernate의 영속성 컨텍스트와 같은 1차 캐시를 사용할 경우, DataSource 접근이 필요하지 않지만 @Transactional로 인해 불필요한 커넥션이 발생하게 됩니다. LazyConnectionDataSourceProxy으로 Proxy객체를 사용할 경우 실제로 Connection이 필요한 시점에 DataSource에 접근하기 때문에 성능상 이점이 많습니다. ↩︎\nEntity Manager는 Thread-Safe하지 않기 때문에, Factory를 통해 필요 시점에 새로운 Entity Manager를 생성해서 활용해야 합니다. 해당 StackOverflow를 읽어보시면, 이 때 주입되는 Entity Manager는 Proxy형태로, 실제 트랜잭션 시점에 진짜 Entity Manager로 대체되기 때문에 Thread-Safe 할 수 있다고 합니다. ↩︎\n참고로 JPA의 EntityManagerFactory대신 Hibernate의 SessionFactory를 구현하는 방법도 있지만, 이는 JPA의 구현체에 의존하므로 좋지 않은 것 같습니다(DIP 위반). 하지만 Hibernate만의 특정 기술을 사용해야만 하는 상황에서는 SessionFactory를 구현 후 TransactionManager에 HibernateTransactionManager를 사용하시면 될 것 같습니다. ↩︎\n원래는 @BeforeEach 를 사용하여 DB를 초기화하면 되지만, 트랜잭션 범위 설정이 클래스 단위로 제한되어 @Transactional(readOnly = true)를 지정하면 init() 메서드에 @Transactional(readOnly = false)를 설정해도 DB에 값이 반영되지 않는 문제가 발생했습니다. 하는 수 없이 위와 같은 방식으로 설계했습니다. ↩︎\n","wordCount":"1230","inLanguage":"ko","image":"http://localhost:1313/cover.png","datePublished":"2024-03-19T20:20:06+09:00","dateModified":"2024-03-19T20:20:06+09:00","author":{"@type":"Person","name":"Leaf"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/cqrs/3/"},"publisher":{"@type":"Organization","name":"봄을 기다리는 낙엽","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="LEAF (Alt + H)">LEAF</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/search/ title=검색><span>검색</span></a></li><li><a href=http://localhost:1313/posts/ title=게시글><span>게시글</span></a></li><li><a href=http://localhost:1313/tips/ title=미세팁><span>미세팁</span></a></li><li><a href=http://localhost:1313/archives/ title=아카이브><span>아카이브</span></a></li><li><a href=http://localhost:1313/cote/ title=알고리즘><span>알고리즘</span></a></li><li><a href=http://localhost:1313/review/ title="책 리뷰"><span>책 리뷰</span></a></li><li><a href=http://localhost:1313/categories/ title=카테고리><span>카테고리</span></a></li><li><a href=http://localhost:1313/tags/ title=태그><span>태그</span></a></li><li><a href=https://github.com/leaf-nam/blog title=Git><span>Git</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>홈</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/cqrs/>[MySQL, Java]Spring CQRS 패턴 구현을 위한 DB 이중화</a></div><h1 class="post-title entry-hint-parent">[Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현</h1><div class=post-description>이중화된 MySQL DB에 접근할 수 있는 DataSource를 설정합니다.</div><div class=post-meta><span title='2024-03-19 20:20:06 +0900 KST'>2024. 3. 19.</span>&nbsp;·&nbsp;6 분&nbsp;·&nbsp;1230 단어&nbsp;·&nbsp;Leaf&nbsp;|&nbsp;<a href=https://github.com/leaf-nam/blog/blob/main/content/ rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=eager srcset="http://localhost:1313/posts/cqrs/3/cover_hu11414675231948756621.png 360w ,http://localhost:1313/posts/cqrs/3/cover_hu6918807630992193863.png 480w ,http://localhost:1313/posts/cqrs/3/cover.png 480w" sizes="(min-width: 768px) 720px, 100vw" src=http://localhost:1313/posts/cqrs/3/cover.png alt="cover image" width=480 height=480><p>돌고래가 뛰어노는 스프링을 만들어봤습니다.</p></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>목차</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#도입>도입</a></li><li><a href=#프로젝트-생성>프로젝트 생성</a></li><li><a href=#jpaconfig-클래스-생성>JpaConfig 클래스 생성</a></li><li><a href=#datasource-구현>DataSource 구현</a><ul><li><a href=#command--read-datasource-bean-생성>Command & Read DataSource Bean 생성</a></li><li><a href=#routingdatasource-구현>RoutingDataSource 구현</a></li></ul></li><li><a href=#entitymanagerfactory-구현>EntityManagerFactory 구현</a></li><li><a href=#transactionmanager-구현>TransactionManager 구현</a></li><li><a href=#테스트>테스트</a><ul><li><a href=#entity-생성>Entity 생성</a></li><li><a href=#테스트코드-작성>테스트코드 작성</a></li></ul></li><li><a href=#결론>결론</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><h2 id=도입>도입<a hidden class=anchor aria-hidden=true href=#도입>#</a></h2><blockquote><p>이전 포스팅 참조 :
<a href=https://leaf-nam.github.io/posts/240310_mysql_springboot_cqrs_%ED%8C%A8%ED%84%B4_%EA%B5%AC%ED%98%84%EC%9D%84_%EC%9C%84%ED%95%9C_db_%EC%9D%B4%EC%A4%91%ED%99%94/240313_mysql_replication_database_%EA%B5%AC%ED%98%84/>DB 이중화 및 CQRS 패턴의 중요성</a> > <a href=https://leaf-nam.github.io/posts/240310_mysql_springboot_cqrs_%ED%8C%A8%ED%84%B4_%EA%B5%AC%ED%98%84%EC%9D%84_%EC%9C%84%ED%95%9C_db_%EC%9D%B4%EC%A4%91%ED%99%94/240313_mysql_replication_database_%EA%B5%AC%ED%98%84/>MySQL Replication Database 구현</a></p></blockquote><blockquote><p>실습환경</p><ul><li>Docker : v25.0.3</li><li>MySQL : v8.3.0</li><li>Java : v17.0.9</li><li>Spring : v3.2.4</li></ul></blockquote><p>저번 시간에 생성한 Master / Slave DB에 SpringBoot를 직접 연동해서 CRUD를 하는 실습을 진행합니다.</p><h2 id=프로젝트-생성>프로젝트 생성<a hidden class=anchor aria-hidden=true href=#프로젝트-생성>#</a></h2><ol><li><a href=https://start.spring.io>Springboot 프로젝트</a>를 생성합니다.</li></ol><ul><li>아래 사진과 같이 JPA, Lombok, MySQL Driver 의존성을 추가하겠습니다.</li></ul><figure><img loading=lazy src=springboot.png alt="스프링부트 프로젝트를 위와 같이 의존성을 추가하여 생성합니다."><figcaption><p>스프링부트 프로젝트를 위와 같이 의존성을 추가하여 생성합니다.</p></figcaption></figure><ol start=2><li>build.gradle 실행</li></ol><ul><li>위에서 생성한 프로젝트의 jar파일을 풀고, build.gradle 파일을 intellij 혹은 eclipse로 실행합니다.</li></ul><figure><img loading=lazy src=gradle.png alt="gradle로 프로젝트를 실행하면 자동으로 소스파일 경로가 생성됩니다."><figcaption><p>gradle로 프로젝트를 실행하면 자동으로 소스파일 경로가 생성됩니다.</p></figcaption></figure><h2 id=jpaconfig-클래스-생성>JpaConfig 클래스 생성<a hidden class=anchor aria-hidden=true href=#jpaconfig-클래스-생성>#</a></h2><p>원래 스프링부트에 JPA 의존성을 추가하면 기본으로 설정된 DataSource를 불러와 사용하지만, 저번 시간에 분리한 Command(쓰기)와 Query(읽기) DB를 DataSource로 사용하기 위해 다음과 같이 JpaConfig를 설정하겠습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.replication.demo.config</span><span class=p>;</span><span class=w> </span><span class=c1>// config 패키지 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w> </span><span class=c1>// Spring에 자동으로 Bean을 등록하기 위함</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JpaConfig</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span></code></pre></div><h2 id=datasource-구현>DataSource 구현<a hidden class=anchor aria-hidden=true href=#datasource-구현>#</a></h2><p>JpaConfig내부에 DataSource를 Bean으로 등록하면, 이후 Spring이 해당 Bean의 설정을 통해 DataSource를 생성하므로 편리하게 DB에 접근할 수 있습니다.</p><blockquote><p>두 개의 DataSource를 각각 구현하고, Transaction시점에 필요한 DataSource를 결정할 수 있도록 Spring에서는 AbstractRoutingDataSource라는 추상클래스를 제공합니다.</p></blockquote><h3 id=command--read-datasource-bean-생성>Command & Read DataSource Bean 생성<a hidden class=anchor aria-hidden=true href=#command--read-datasource-bean-생성>#</a></h3><p>우선, 쓰기와 읽기 DataSource를 다음과 같이 JpaConfig 내부에서 Bean으로 등록합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>JpaConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;commandDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 원본 DB와 연결된 DataSource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>commandDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>HikariDataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataSourceBuilder</span><span class=p>.</span><span class=na>create</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>driverClassName</span><span class=p>(</span><span class=s>&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>url</span><span class=p>(</span><span class=s>&#34;jdbc:mysql://localhost:3307/target_db&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>username</span><span class=p>(</span><span class=s>&#34;master_user&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=s>&#34;1234&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>type</span><span class=p>(</span><span class=n>HikariDataSource</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setMaximumPoolSize</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w> </span><span class=c1>// Pool Size도 설정 가능합니다.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;queryDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// Repl DB와 연결된 DataSource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>queryDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>HikariDataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DataSourceBuilder</span><span class=p>.</span><span class=na>create</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>driverClassName</span><span class=p>(</span><span class=s>&#34;com.mysql.cj.jdbc.Driver&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>url</span><span class=p>(</span><span class=s>&#34;jdbc:mysql://localhost:3308/target_db&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>username</span><span class=p>(</span><span class=s>&#34;slave_user&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>password</span><span class=p>(</span><span class=s>&#34;1234&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>type</span><span class=p>(</span><span class=n>HikariDataSource</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>dataSource</span><span class=p>.</span><span class=na>setMaximumPoolSize</span><span class=p>(</span><span class=n>5</span><span class=p>);</span><span class=w> </span><span class=c1>// 보통 읽기전용 작업이 더 많기 때문에 크게 설정하겠습니다.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>jdbc에서 사용하는 port 및 username과 password는 <a href=https://leaf-nam.github.io/posts/240310_mysql_springboot_cqrs_%ED%8C%A8%ED%84%B4_%EA%B5%AC%ED%98%84%EC%9D%84_%EC%9C%84%ED%95%9C_db_%EC%9D%B4%EC%A4%91%ED%99%94/240313_mysql_replication_database_%EA%B5%AC%ED%98%84/#master-db-%EC%83%9D%EC%84%B1>저번 시간</a>에 생성한 DB 환경변수를 참고하시면 됩니다.</p></blockquote><h3 id=routingdatasource-구현>RoutingDataSource 구현<a hidden class=anchor aria-hidden=true href=#routingdatasource-구현>#</a></h3><p>읽기전용 트랜잭션인지 여부에 따라 동적으로 DataSource를 사용해야 하므로, 스프링에게 트랜잭션 시점에 해당 작업에 대해 알려주고, 필요한 DataSource를 동적으로 불러오도록 해야 합니다.</p><p>이를 위해 다음과 같이 추상 클래스인 AbstractRoutingDataSource를 상속받는 사용자 정의 클래스를 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Slf4j</span><span class=w> </span><span class=c1>// AbstractRoutingDataSource 구현</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>ReplicationRoutingDataSource</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>AbstractRoutingDataSource</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>protected</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>determineCurrentLookupKey</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>isReadOnly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TransactionSynchronizationManager</span><span class=p>.</span><span class=na>isCurrentTransactionReadOnly</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Use ReadOnly Datasource : {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>isReadOnly</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>isReadOnly</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;replication&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;original&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>위 설정에서 determineCurrentLookupKey 메서드를 구현하면 동적으로 DataSource를 라우팅하는 것이 가능한데, 그 key를 TransactionSynchronizationManager<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>의 속성값(isCurrentTransactionReadOnly; 현재 트랜잭션이 읽기전용인지?)으로 사용해서 DataSource를 읽기 / 쓰기 시점에 결정합니다.</p></blockquote><p>다음으로 위 클래스를 활용해서 실제로 DataSource를 결정 후 해당 DataSource를 Bean으로 등록합니다.</p><p>ReplicationRoutingDataSource 클래스는 AbstractRoutingDataSource를 상속받고 있기 때문에 해당 추상클래스의 메서드를 사용가능하여 다음과 같이 ReadOnly 여부에 따른 데이터소스를 설정하는 것이 가능합니다.</p><blockquote><p>ReadOnly여부는 @Transactional(readOnly = true)인지를 확인하여 결정됩니다. 이 때, org.springframework.transaction.annotation.Transactional을 사용해야 함을 주의합니다. (jakarta.transactional 아님!!)</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;routingDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// DataSource 종류에 따른 DataSource 라우팅(변경)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>routingDataSource</span><span class=p>(</span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;commandDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>commandDataSource</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;queryDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>queryDataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ReplicationRoutingDataSource</span><span class=w> </span><span class=n>routingDataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReplicationRoutingDataSource</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// DataSource 라우팅</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataSourceMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;command&#34;</span><span class=p>,</span><span class=w> </span><span class=n>commandDataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSourceMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;query&#34;</span><span class=p>,</span><span class=w> </span><span class=n>queryDataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 기본 DataSource 및 ReadOnly 여부에 따른 DataSource 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>routingDataSource</span><span class=p>.</span><span class=na>setDefaultTargetDataSource</span><span class=p>(</span><span class=n>commandDataSource</span><span class=p>);</span><span class=w> </span><span class=c1>// commandDataSource를 기본 사용</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>routingDataSource</span><span class=p>.</span><span class=na>setTargetDataSources</span><span class=p>(</span><span class=n>dataSourceMap</span><span class=p>);</span><span class=w> </span><span class=c1>// ReadOnly여부에 따른 DataSource 변경</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>routingDataSource</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>다음으로 위의 Bean을 LazyConnectionDataSourceProxy으로 감싸는데, 이는 트랜잭션 진입 시점이 아닌 실제 커넥션이 필요한 시점<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>에 DataSource를 결정하기 위함입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;routingLazyDataSource&#34;</span><span class=p>)</span><span class=w>  </span><span class=c1>// Connection 시점에 DataSource 결정하기 위한 Proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>routingLazyDataSource</span><span class=p>(</span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;routingDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>routingDataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LazyConnectionDataSourceProxy</span><span class=p>(</span><span class=n>routingDataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=entitymanagerfactory-구현>EntityManagerFactory 구현<a hidden class=anchor aria-hidden=true href=#entitymanagerfactory-구현>#</a></h2><p>Spring에서는 트랜잭션의 동시성 문제<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>를 해결하기 위해 EntityManager를 트랜잭션 시마다 생성하는 Factory Method 패턴을 구현하고 있습니다. 이를 위해 저희도 EntityManagerFactory에 위에서 설정한 DataSource를 직접 주입함으로써 동시성 문제를 해결할 수 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;entityManagerFactory&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// Entity 를 관리하기 위한 JPA Manager 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>LocalContainerEntityManagerFactoryBean</span><span class=w> </span><span class=nf>entityManagerFactory</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;routingLazyDataSource&#34;</span><span class=p>)</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LocalContainerEntityManagerFactoryBean</span><span class=w> </span><span class=n>emf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LocalContainerEntityManagerFactoryBean</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// DataSource 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emf</span><span class=p>.</span><span class=na>setDataSource</span><span class=p>(</span><span class=n>dataSource</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// EntityManager 가 관리할 Base Package 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emf</span><span class=p>.</span><span class=na>setPackagesToScan</span><span class=p>(</span><span class=s>&#34;com.replication.demo.*&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Hibernate Vendor Adaptor 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HibernateJpaVendorAdapter</span><span class=w> </span><span class=n>hibernateJpaVendorAdapter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HibernateJpaVendorAdapter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>hibernateJpaVendorAdapter</span><span class=p>.</span><span class=na>setDatabasePlatform</span><span class=p>(</span><span class=s>&#34;org.hibernate.dialect.MySQLDialect&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emf</span><span class=p>.</span><span class=na>setJpaVendorAdapter</span><span class=p>(</span><span class=n>hibernateJpaVendorAdapter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// JPA 및 Hibernate 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Properties</span><span class=w> </span><span class=n>properties</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Properties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>properties</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;spring.jpa.hibernate.ddl-auto&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;create-drop&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>properties</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;hibernate.show_sql&#34;</span><span class=p>,</span><span class=s>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>properties</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;hibernate.format_sql&#34;</span><span class=p>,</span><span class=s>&#34;true&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>properties</span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;hibernate.default_batch_fetch_size&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;100&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>emf</span><span class=p>.</span><span class=na>setJpaProperties</span><span class=p>(</span><span class=n>properties</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>emf</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>Vendor Adaptor는 JPA 구현체를 선택하기 위함이며, 보통 Hibernate를 많이 사용합니다.<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> 기타 JPA 및 Hibernate 설정은 <a href=https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.data>JPA 공식 문서</a>와 <a href=https://docs.jboss.org/hibernate/orm/6.4/userguide/html_single/Hibernate_User_Guide.html#settings>Hibernate 공식 문서</a>에서 더욱 자세한 옵션과 설명을 확인하실 수 있습니다.</p></blockquote><h2 id=transactionmanager-구현>TransactionManager 구현<a hidden class=anchor aria-hidden=true href=#transactionmanager-구현>#</a></h2><p>Spring에서 @Transactional를 통해 트랜잭션이 발생하면, Spring Container에서 TransactinManager를 불러와 트랜잭션을 수행합니다. 이 때, 위에서 구현한 DataSource와 EntityManager를 사용해서 트랜잭션을 수행하도록 하겠습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=p>(</span><span class=s>&#34;transactionManager&#34;</span><span class=p>)</span><span class=w>  </span><span class=c1>// 트랜잭션 매니저 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PlatformTransactionManager</span><span class=w> </span><span class=nf>transactionManager</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Qualifier</span><span class=p>(</span><span class=s>&#34;entityManagerFactory&#34;</span><span class=p>)</span><span class=w> </span><span class=n>EntityManagerFactory</span><span class=w> </span><span class=n>entityManagerFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JpaTransactionManager</span><span class=w> </span><span class=n>jpaTransactionManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JpaTransactionManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>jpaTransactionManager</span><span class=p>.</span><span class=na>setEntityManagerFactory</span><span class=p>(</span><span class=n>entityManagerFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>jpaTransactionManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>PlatformTransactionManager는 다양한 플랫폼의 트랜잭션을 지원하기 위한 클래스이며, 위에서는 JpaTransactionManager를 사용했지만 HibernateTransactionManager나 JdbcTransactionManager등의 플랫폼도 사용 가능합니다.</p></blockquote><h2 id=테스트>테스트<a hidden class=anchor aria-hidden=true href=#테스트>#</a></h2><p>이제 Config 설정이 완료되었으니, 직접 Test를 통해 원하는 기능이 제대로 실행되는지 확인해보겠습니다.</p><h3 id=entity-생성>Entity 생성<a hidden class=anchor aria-hidden=true href=#entity-생성>#</a></h3><p>테스트코드를 작성하기 전, DB에 저장할 엔티티 클래스를 먼저 생성하겠습니다.</p><ul><li><p>User Entity 생성</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.replication.demo.entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.persistence.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Entity</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;users&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Getter</span><span class=w> </span><span class=nd>@Setter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>User</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Id</span><span class=w> </span><span class=nd>@GeneratedValue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;user_id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@OneToMany</span><span class=p>(</span><span class=n>mappedBy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;owner&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Computer</span><span class=o>&gt;</span><span class=w> </span><span class=n>computers</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Computer Entity 생성</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>package</span><span class=w> </span><span class=nn>com.replication.demo.entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.persistence.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Getter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.NoArgsConstructor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.Setter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Entity</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;computer&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Getter</span><span class=w> </span><span class=nd>@Setter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Computer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Id</span><span class=w> </span><span class=nd>@GeneratedValue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;computer_id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Enumerated</span><span class=p>(</span><span class=n>EnumType</span><span class=p>.</span><span class=na>STRING</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ComputerType</span><span class=w> </span><span class=n>type</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Column</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;os&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>OS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ManyToOne</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@JoinColumn</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;owner_id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>User</span><span class=w> </span><span class=n>owner</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li><li><p>Computer Type 생성</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.replication.demo.entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=n>ComputerType</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MAC</span><span class=p>,</span><span class=w> </span><span class=n>WINDOW</span><span class=p>,</span><span class=w> </span><span class=n>LINUX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></li></ul><h3 id=테스트코드-작성>테스트코드 작성<a hidden class=anchor aria-hidden=true href=#테스트코드-작성>#</a></h3><p>마지막으로, 테스트코드를 통해 Command(readOnly = false) 트랜잭션과 Query(readOnly = true) 트랜잭션을 분리하여 정상적으로 조회되는지 확인해보겠습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.replication.demo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.replication.demo.entity.Computer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.replication.demo.entity.ComputerType</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.replication.demo.entity.User</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.persistence.EntityManager</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>jakarta.persistence.PersistenceContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.junit.jupiter.api.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.boot.test.context.SpringBootTest</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.test.annotation.Rollback</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.transaction.annotation.Transactional</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.ArrayList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import static</span><span class=w> </span><span class=nn>org.assertj.core.api.Assertions.assertThat</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@TestMethodOrder</span><span class=p>(</span><span class=n>MethodOrderer</span><span class=p>.</span><span class=na>OrderAnnotation</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>class</span> <span class=nc>DemoApplicationTests</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@PersistenceContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>EntityManager</span><span class=w> </span><span class=n>em</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Order</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kt>void</span><span class=w> </span><span class=nf>contextLoads</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Order</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;최초 데이터 입력&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>readOnly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Rollback</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 사용자 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>User</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>user</span><span class=p>.</span><span class=na>setAge</span><span class=p>(</span><span class=n>28</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>user</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;leaf&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 컴퓨터 1 생성 및 저장</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Computer</span><span class=o>&gt;</span><span class=w> </span><span class=n>computers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>Computer</span><span class=w> </span><span class=n>macCom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Computer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>macCom</span><span class=p>.</span><span class=na>setOS</span><span class=p>(</span><span class=s>&#34;Ventura&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>macCom</span><span class=p>.</span><span class=na>setType</span><span class=p>(</span><span class=n>ComputerType</span><span class=p>.</span><span class=na>MAC</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>macCom</span><span class=p>.</span><span class=na>setOwner</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>computers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>macCom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>macCom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 컴퓨터 2 생성 및 저장</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>Computer</span><span class=w> </span><span class=n>windowCom</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Computer</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>windowCom</span><span class=p>.</span><span class=na>setOS</span><span class=p>(</span><span class=s>&#34;WINDOW 11&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>windowCom</span><span class=p>.</span><span class=na>setType</span><span class=p>(</span><span class=n>ComputerType</span><span class=p>.</span><span class=na>WINDOW</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>windowCom</span><span class=p>.</span><span class=na>setOwner</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>computers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>windowCom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>windowCom</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>// 컴퓨터 사용자에 추가 후 사용자 저장</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>user</span><span class=p>.</span><span class=na>setComputers</span><span class=p>(</span><span class=n>computers</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Order</span><span class=p>(</span><span class=n>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@DisplayName</span><span class=p>(</span><span class=s>&#34;사용자 조회 시 컴퓨터 잘 불러오는지 테스트&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>readOnly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kt>void</span><span class=w> </span><span class=nf>userQueryWithComputer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=c1>// given</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>List</span><span class=o>&lt;</span><span class=n>User</span><span class=o>&gt;</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		  			</span><span class=s>&#34;select u &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=s>&#34;from users as u &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=s>&#34;join u.computers as c&#34;</span><span class=p>,</span><span class=w> </span><span class=n>User</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=c1>// when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>User</span><span class=w> </span><span class=n>userInDB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>users</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=c1>// then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 사용자명, 나이 테스트</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getName</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;leaf&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getAge</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>28</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getComputers</span><span class=p>()).</span><span class=na>hasSize</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 맥북 컴퓨터 가지고 있는지 테스트</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getComputers</span><span class=p>()).</span><span class=na>anyMatch</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>getOS</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;Ventura&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getComputers</span><span class=p>()).</span><span class=na>anyMatch</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>getType</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>ComputerType</span><span class=p>.</span><span class=na>MAC</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 윈도우 컴퓨터 가지고 있는지 테스트</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getComputers</span><span class=p>()).</span><span class=na>anyMatch</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>getOS</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;WINDOW 11&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>assertThat</span><span class=p>(</span><span class=n>userInDB</span><span class=p>.</span><span class=na>getComputers</span><span class=p>()).</span><span class=na>anyMatch</span><span class=p>(</span><span class=n>c</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>c</span><span class=p>.</span><span class=na>getType</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>ComputerType</span><span class=p>.</span><span class=na>WINDOW</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>@RollBack(false)를 통해 롤백을 방지한 후 다음 테스트가 실행되도록 설계했습니다.<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p></blockquote><figure><img loading=lazy src=test_result.png alt="테스트 실행결과, 위와 같이 데이터소스 선택 및 실제 SQL이 잘 나가는 것을 확인할 수 있습니다."><figcaption><p>테스트 실행결과, 위와 같이 데이터소스 선택 및 실제 SQL이 잘 나가는 것을 확인할 수 있습니다.</p></figcaption></figure><h2 id=결론>결론<a hidden class=anchor aria-hidden=true href=#결론>#</a></h2><p>지금까지 이중화된 DB의 데이터소스를 SpringBoot에서 동적으로 선택하여 실제 DB와 연동 후 테스트까지 수행했습니다. 해당 프로젝트의 소스코드는 <a href=https://github.com/leaf-nam/replication_demo>깃허브</a>에 올려두었으니, 필요 시 참고하시기 바랍니다.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><table><thead><tr><th style=text-align:left>URL</th><th style=text-align:left>게시일자</th><th style=text-align:left>방문일자</th><th style=text-align:left>작성자</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://docs.spring.io/spring-data/relational/reference/jdbc/getting-started.html>https://docs.spring.io/spring-data/relational/reference/jdbc/getting-started.html</a></td><td style=text-align:left>미확인</td><td style=text-align:left>2024.03.31.</td><td style=text-align:left>Spring</td></tr><tr><td style=text-align:left><a href=https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.data>https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#appendix.application-properties.data</a></td><td style=text-align:left>미확인</td><td style=text-align:left>2024.04.10.</td><td style=text-align:left>Spring</td></tr><tr><td style=text-align:left><a href=https://stackoverflow.com/questions/24643863/is-entitymanager-really-thread-safe>https://stackoverflow.com/questions/24643863/is-entitymanager-really-thread-safe</a></td><td style=text-align:left>2014.07.09.</td><td style=text-align:left>2024.04.10.</td><td style=text-align:left>Ken Y-N</td></tr></tbody></table><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>트랜잭션 동기화 기법을 사용하기 위한 클래스입니다. 보통 여러 트랜잭션을 한번에 커밋 및 롤백하여 정합성을 보장하기 위해 사용합니다.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>특히 Hibernate의 영속성 컨텍스트와 같은 1차 캐시를 사용할 경우, DataSource 접근이 필요하지 않지만 @Transactional로 인해 불필요한 커넥션이 발생하게 됩니다. LazyConnectionDataSourceProxy으로 Proxy객체를 사용할 경우 실제로 Connection이 필요한 시점에 DataSource에 접근하기 때문에 성능상 이점이 많습니다.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Entity Manager는 Thread-Safe하지 않기 때문에, Factory를 통해 필요 시점에 새로운 Entity Manager를 생성해서 활용해야 합니다. <a href=https://stackoverflow.com/questions/24643863/is-entitymanager-really-thread-safe>해당 StackOverflow</a>를 읽어보시면, 이 때 주입되는 Entity Manager는 Proxy형태로, 실제 트랜잭션 시점에 진짜 Entity Manager로 대체되기 때문에 Thread-Safe 할 수 있다고 합니다.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>참고로 JPA의 EntityManagerFactory대신 Hibernate의 SessionFactory를 구현하는 방법도 있지만, 이는 JPA의 구현체에 의존하므로 좋지 않은 것 같습니다(DIP 위반). 하지만 Hibernate만의 특정 기술을 사용해야만 하는 상황에서는 SessionFactory를 구현 후 TransactionManager에 HibernateTransactionManager를 사용하시면 될 것 같습니다.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>원래는 @BeforeEach 를 사용하여 DB를 초기화하면 되지만, 트랜잭션 범위 설정이 클래스 단위로 제한되어 @Transactional(readOnly = true)를 지정하면 init() 메서드에 @Transactional(readOnly = false)를 설정해도 DB에 값이 반영되지 않는 문제가 발생했습니다. 하는 수 없이 위와 같은 방식으로 설계했습니다.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/springboot/>Springboot</a></li><li><a href=http://localhost:1313/tags/implement/>Implement</a></li><li><a href=http://localhost:1313/tags/mysql/>Mysql</a></li><li><a href=http://localhost:1313/tags/datasource/>Datasource</a></li><li><a href=http://localhost:1313/tags/jpa/>JPA</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/tips/240320/><span class=title>« 이전 페이지</span><br><span>Springboot Junit 단위테스트에서 로그 레벨 조정하기</span>
</a><a class=next href=http://localhost:1313/posts/cqrs/2/><span class=title>다음 페이지 »</span><br><span>[MySQL]Replication Database 구현</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on x" href="https://x.com/intent/tweet/?text=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f&amp;hashtags=springboot%2cimplement%2cmysql%2cdatasource%2cjpa"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f&amp;title=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84&amp;summary=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f&title=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on whatsapp" href="https://api.whatsapp.com/send?text=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on telegram" href="https://telegram.me/share/url?text=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share [Java]SpringBoot DataSource 이중화(CQRS 패턴) 구현 on ycombinator" href="https://news.ycombinator.com/submitlink?t=%5bJava%5dSpringBoot%20DataSource%20%ec%9d%b4%ec%a4%91%ed%99%94%28CQRS%20%ed%8c%a8%ed%84%b4%29%20%ea%b5%ac%ed%98%84&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fcqrs%2f3%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://utteranc.es/client.js repo=leaf-nam/leaf-nam.github.io issue-term=title theme=boxy-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>봄을 기다리는 낙엽</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="복사";function s(){t.innerHTML="복사 완료!",setTimeout(()=>{t.innerHTML="복사"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>